<!DOCTYPE html>
<html>
	<head>
		<!-- Meta -->
		<meta charset="utf-8">
		<title>Mapplic - Custom Interactive Map Plugin - Apartment Example</title>
		
		<!-- Viewport for Responsivity -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		
		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<!-- Favicon -->
		<link rel="shortcut icon" type="image/png" href="favicon.png"/>
		
		<meta name="description" content="Image map of an apartment, an example of using Mapplic, a premium custom interactive map plugin to display custom image or vector (SVG) maps.">
		
		<!-- Stylesheets -->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="css/magnific-popup.css">
		<link rel="stylesheet" type="text/css" href="mapplic/mapplic.css">
	</head>
	<body>
		<div id="wrap">
			
			<!-- Site header -->
			<header id="header">
				
				
			</header>
			
			<!-- Site content -->
			<div id="content">
				
				<section id="map-section" class="inner over">
					<div class="editor-window">
						<div class="editor-body">
							<code>
								{<br>
								&nbsp;&nbsp;&nbsp;"id": "newlandmark",<br>
								&nbsp;&nbsp;&nbsp;"title": "New Landmark",<br>
								&nbsp;&nbsp;&nbsp;"description": "Creating a new landmark is that easy!",<br>
								&nbsp;&nbsp;&nbsp;"x": "<span class="mapplic-coordinates-x">0.0000</span>",<br>
								&nbsp;&nbsp;&nbsp;"y": "<span class="mapplic-coordinates-y">0.0000</span>",<br>
								&nbsp;&nbsp;&nbsp;...<br>
								}
							</code>
						</div>
					</div>
					
					<div class="map-container">
						<div id="mapplic"></div> <!-- Map -->
					</div>
					
					
				</section>
				
				
				
			</div>
			
			<!-- Site footer -->
			<footer id="footer" class="dark">
				
				
			</footer>
		</div>
		
		
		
		<div class="pin_form">
			<form id="form_locations" autocomplete="off">
				<div class="">
					<label >ID	</label >
					<input class="form-control input-sm" id="id_location" name="id">
				</div>
				
				<div class="form-groups">
					<label >Titulo	</label >
					<input class="form-control " id="title" name="title">
				</div>
				
				<div class="form-groups">
					<label >Subtítulo	</label >
					<input class="form-control" id="about" name="about">
				</div>
				
				<div class="form-groups">
					<label >Descripción	</label >
					<input class="form-control" id="description" name="description">
				</div>
				
				<div class="form-groups">
					<label >Pin	(Clase CSS)</label >
					<input class="form-control" id="pin" name="pin">
				</div>
				
				<div class="form-groups">
					<label >Categoria	</label >
					<select id="category" name="category" class="form-control">
						<option value="locations">Servicios</option>
						<option value="sanitarios">Sanitarios</option>
						<option value="estacionamientos">Estacionamientos</option>
					</select>
				</div>
				
				<div class="form-groups">
					<label >X	</label >
					<input class="form-control" id="x" name="x">
				</div>
				
				<div class="form-groups">
					<label >Y	</label >
					<input class="form-control" id="y" name="y">
				</div>
				
				<button id="" class="btn btn-success">
					Guardar
				</button>
				
			</form>
		</div>
		
		<style>
			.pin_form{
			display: none;
			position :fixed;
			left :0px;
			top : 60px;
			width: 200px;
			background-color: #e0e0e0;
			}
		</style>
		
		<!-- Scripts -->
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery.mousewheel.js"></script>
		<script type="text/javascript" src="js/script.js"></script>
		<script type="text/javascript" src="js/magnific-popup.js"></script>
		<script type="text/javascript" src="mapplic/mapplic.js"></script>
		<script type="text/javascript">
			
			
			$(document).ready(function() {
				
				
				var map = $('#mapplic').mapplic({
					source: 'diospadre.json',
					height: 560,
					hovertip: true,
					mapfill: true,
					lightbox: true,
					thumbholder: true,
					developer: true,
					fillcolor: '#495360',
					closezoomout: true,
					minimap: false,
					fullscreen: true,
					zoomMargin: 0,
					maxscale: 2
				});
				
				
				var self = map.data('mapplic');
				
				
				$("#form_locations").submit( function newLocation(e){
					
					var source_json;
					e.preventDefault();
					console.log("Guardar Ubicacion")
					
					$.getJSON(self.o.source, function(data) {
						source_json = data;
						
						console.log("Data", self.o )
						
						new_location = 
						{
							"id": $("#id_location").val(),
							"title": $("#title").val(),
							"about": $("#about").val(),
							"description": $("#description").val(),
							"category": $("#category").val(),
							"x": $("#x").val(),
							"y": $("#y").val(),
							"zoom": "2",
							"pin": "p"
						};
						
						source_json.levels[0].locations.push(new_location);
						
						console.log("New data", source_json);
						
						$.ajax({
							url: "update_json.php",
							method: "POST",
							data: {
								"json": JSON.stringify(source_json),
								"filename": self.o.source
								
							}
							
							}).done(function(respuesta){
							
							alert(respuesta);
							console.log(respuesta);
							
						})
						
						}).fail(function() { // Failure: couldn't load JSON file or it is invalid.
						console.error('Couldn\'t load map data. (Make sure to run the script through web server)');
						
					});
					
					
					
					<!-- $(this).find("input").each(function(index, item){ -->
					<!-- new_locations =  -->
					
					<!-- }) -->
				});
				
				
				// EVENTS
				// Map ready
				map.on('mapready', function(e, self) {
					console.log('Map is ready!')
					console.log('self', self);
					console.log('map', map);
					console.log('self.lat', self.lat);
					console.log('location.lat', self.lat);
					
					$(".mapplic-layer").click(function(e){
						
						console.log("click on map");
						
						console.log("Nueva ubicacion")
						let x_coord = $('.mapplic-coordinates-x').text();
						let y_coord = $('.mapplic-coordinates-y').text();
						
						console.log("x_coord", x_coord);
						console.log("y_coord", y_coord);
						
						$("#x").val(x_coord);
						$("#y").val(y_coord);
						
						$(".pin_form").show();
						$("#form_locations").show();
						
						
					})
					// self grants direct access to the map object
					// The map will be focused on the washing machine by default
					//self.moveTo(0.67, 0.62, 3, 0);
					
					
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(function(position) {
							var location = self.l['pos'];
							location.lat = position.coords.latitude;
							location.lng = position.coords.longitude;
							self.updateLocation('pos');
						});
					}
					else console.log('Geolocation is disabled.');
				});
				
				
				// Location opened
				map.on('locationopened', function(e, location) {
					// location grants full access to the location
					console.log(location.title + ' opened.');
					console.log("location" , location);
				});
				
				// Location closed
				map.on('locationclosed', function(e) {
					console.log('Location closed.');
				});
				
				
				$('.mapplic-layer').on('click', function(e) {
					var x = (e.pageX - self.map.offset().left) / self.map.width(),
					y = (e.pageY - self.map.offset().top) / self.map.height();
					<!-- $('.mapplic-coordinates-x').text(parseFloat(x).toFixed(4)); -->
					<!-- $('.mapplic-coordinates-y').text(parseFloat(y).toFixed(4)); -->
					
					console.log("X coordinate", x );
					console.log("y coordinate", y );
				});
				
				// Level switched
				map.on('levelswitched', function(e, level) {
					console.log('Switched to ' + level + ' level.');
				});
				
				// Position changed
				map.on('positionchanged', function(e, self) {
					// self grants direct access to the map object
					//console.log('Pan or zoom performed, current scale: ' + self.scale);
				});
				
				// METHODS
				// Getting mapplic object
				
				map.on('locationclosed', function(e) {
					//console.log(self);
				});
				
				
			});
			
			
			//https://dev.to/deinsoftware/how-to-make-crud-operations-in-json-12he
		</script>
	</body>
</html>		